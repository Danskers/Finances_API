{% extends "base.html" %}
{% block content %}

<div class="card">
    <h2>Agregar transacci√≥n</h2>

    <form method="POST" enctype="multipart/form-data">
        <label>Monto:</label>
        <input type="number" name="monto" step="0.01" required>

        <label for="factura">Factura (opcional)</label>
        <input type="file" id="factura" name="factura" accept="image/*,application/pdf">

        <label>Tipo:</label>
        <select name="tipo" required>
            <option value="ingreso">Ingreso</option>
            <option value="gasto">Gasto</option>
            <option value="deuda">Deuda</option>
        </select>

        <label>Categor√≠a:</label>
        <select name="categoria" required>
            <option value="fijo">Fijo</option>
            <option value="variable">Variable</option>
        </select>

        <label>Subcategor√≠a (si fijo):</label>
        <select name="subcategoria">
            <option value="">--</option>
            <option value="luz">Luz</option>
            <option value="agua">Agua</option>
            <option value="gas">Gas</option>
            <option value="internet">Internet</option>
            <option value="mercado">Mercado</option>
            <option value="tv">Televisi√≥n</option>
            <option value="streaming">Streaming</option>
            <option value="seguros">Seguros</option>
            <option value="cuota">Cuota</option>
            <option value="administraci√≥n">Administraci√≥n</option>
            <option value="plan celular">Plan celular</option>
            <option value="otro">Otro</option>
        </select>

        <label>Cuenta:</label>
        <select name="cuenta_id" required>
            {% for c in cuentas %}
            <option value="{{ c.id }}">{{ c.nombre }}</option>
            {% endfor %}
        </select>

        <button class="btn btn-primary" type="submit">Agregar</button>
    </form>
</div>

<div class="card">
    <h2>Transacciones ‚Äì {{ mes }}</h2>

    <!-- BOT√ìN CONSULTAR FACTURAS -->
    {% if transacciones_with_factura %}
    <div style="margin-bottom: 20px;">
        <button onclick="document.getElementById('lista-facturas').style.display = 'block'; this.style.display = 'none';"
                class="btn btn-primary">
            Consultar facturas adjuntas ({{ transacciones_with_factura|length }})
        </button>

    <div id="lista-facturas" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
        <h3 style="margin-top: 0;">üìé Facturas adjuntas</h3>
        <ul style="list-style: none; padding: 0;">
            {% for t in transacciones_with_factura %}
            <li style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <strong>{{ t.fecha.strftime('%Y-%m-%d') }} ‚Äî ${{ '%.2f'|format(t.monto) }} ({{ t.tipo }})</strong><br>
                <a href="{{ t.factura_url }}" target="_blank" style="color: var(--accent2); text-decoration: underline;">
                    ü°• Abrir factura adjunta
                </a>
            </li>
            {% endfor %}
        </ul>
        <button onclick="document.getElementById('lista-facturas').style.display = 'none'; document.querySelector('button[onclick*=\"lista-facturas\"]').style.display = 'block';"
                class="btn-ghost" style="margin-top: 10px;">
            Ocultar facturas
        </button>
    </div>
        </div>
    </div>
    {% endif %}
    <!-- FIN BOT√ìN CONSULTAR FACTURAS -->

    <!-- BUSCADOR -->
    <form method="get" action="/transacciones" class="flex-between" style="margin-bottom: 16px;">
        <input type="text" name="q" placeholder="Buscar transacciones..." value="{{ q }}"
               style="padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:white; width:250px;">
        <input type="hidden" name="mes" value="{{ mes }}">
        <button class="btn btn-primary">Buscar</button>
    </form>

    <ul class="tx-list">
        {% for t in transacciones %}
        <li class="tx-row">
            <div class="tx-left">
                <div class="tx-icon">
                    {% if t.tipo == "ingreso" %}üíö{% elif t.tipo == "gasto" %}‚ù§Ô∏è{% else %}‚ö†Ô∏è{% endif %}
                </div>
                <div>
                    <div class="tx-title">${{ '%.2f'|format(t.monto) }}</div>
                    <div class="tx-meta">{{ t.fecha.strftime('%Y-%m-%d') }} ‚Äî {{ t.categoria }} / {{ t.subcategoria|default("") }}</div>
                </div>
            </div>
            <div class="tx-right">
                {{ t.tipo }}
                <form action="/transaccion/eliminar/{{ t.id }}" method="post" style="display:inline;">
                    <button class="btn-ghost" style="margin-left:10px; color:#ef4444;">Eliminar</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

{% endblock %}