{% extends "base.html" %}
{% block content %}

<div class="card">
    <h2>Agregar transacci√≥n</h2>

    <form method="POST" enctype="multipart/form-data">
        <label>Monto:</label>
        <input type="number" name="monto" step="0.01" required>

        <label for="factura">Factura (opcional)</label>
        <input type="file" id="factura" name="factura" accept="image/*,application/pdf">

        <label>Tipo:</label>
        <select name="tipo" required>
            <option value="ingreso">Ingreso</option>
            <option value="gasto">Gasto</option>
            <option value="deuda">Deuda</option>
        </select>

        <label>Categor√≠a:</label>
        <select name="categoria" required>
            <option value="fijo">Fijo</option>
            <option value="variable">Variable</option>
        </select>

        <label>Subcategor√≠a (si fijo):</label>
        <select name="subcategoria">
            <option value="">--</option>
            <option value="luz">Luz</option>
            <option value="agua">Agua</option>
            <option value="gas">Gas</option>
            <option value="internet">Internet</option>
            <option value="mercado">Mercado</option>
            <option value="tv">Televisi√≥n</option>
            <option value="streaming">Streaming</option>
            <option value="seguros">Seguros</option>
            <option value="cuota">Cuota</option>
            <option value="administraci√≥n">Administraci√≥n</option>
            <option value="plan celular">Plan celular</option>
            <option value="otro">Otro</option>
        </select>

        <label>Cuenta:</label>
        <select name="cuenta_id" required>
            {% for c in cuentas %}
            <option value="{{ c.id }}">{{ c.nombre }}</option>
            {% endfor %}
        </select>

        <button class="btn btn-primary" type="submit">Agregar</button>
    </form>
</div>

<div class="card">
    <h2>Transacciones ‚Äì {{ mes }}</h2>

    <!-- BUSCADOR -->
    <form method="get" action="/transacciones" class="flex-between" style="margin-bottom: 16px;">
        <input
            type="text"
            name="q"
            placeholder="Buscar transacciones..."
            value="{{ q }}"
            style="padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:white; width:250px;"
        >
        <input type="hidden" name="mes" value="{{ mes }}">
        <button class="btn btn-primary" style="cursor:pointer;">Buscar</button>
    </form>
    <!-- FIN BUSCADOR -->

    <ul class="tx-list">
        {% for t in transacciones %}
        <li class="tx-row" style="flex-direction: column; align-items: flex-start; padding-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; width: 100%;">
                <div class="tx-left">
                    <div class="tx-icon">
                        {% if t.tipo == "ingreso" %}üíö{% elif t.tipo == "gasto" %}‚ù§Ô∏è{% else %}‚ö†Ô∏è{% endif %}
                    </div>
                    <div>
                        <div class="tx-title">${{ '%.2f'|format(t.monto) }}</div>
                        <div class="tx-meta">{{ t.fecha.strftime('%Y-%m-%d') }} ‚Äî {{ t.categoria }} / {{ t.subcategoria }}</div>
                    </div>
                </div>
                <div class="tx-right" style="flex-direction: column; align-items: flex-end; gap: 8px;">
                    <span style="font-size: 0.9em; color: var(--accent2);">{{ t.tipo }}</span>
                    <div>
                        <form action="/transaccion/eliminar/{{ t.id }}" method="post" style="display:inline;">
                            <button class="btn-ghost" style="color:#ef4444; font-size: 0.85em;">
                                Eliminar
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- MOSTRAR IMAGEN O PDF SI EXISTE -->
            {% if t.url_imagen %}
            <div style="margin-top: 12px; width: 100%; text-align: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <a href="{{ t.url_imagen }}" target="_blank">
                    {% if t.url_imagen.endswith '.pdf' %}
                        <div style="padding: 40px; background: #f8f8f8; color: #333; border-radius: 8px; display: inline-block;">
                            üìÑ Ver factura PDF
                        </div>
                    {% else %}
                        <img src="{{ t.url_imagen }}"
                             alt="Factura"
                             style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.02)'"
                             onmouseout="this.style.transform='scale(1)'">
                    {% endif %}
                </a>
                <p style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">
                    <a href="{{ t.url_imagen }}" target="_blank" style="color: var(--accent2); text-decoration: underline;">
                        Abrir en pesta√±a nueva
                    </a>
                </p>
            </div>
            {% endif %}
            <!-- FIN IMAGEN -->

        </li>
        {% endfor %}
    </ul>
</div>

{% endblock %}